<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Hojas CSV</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        th,
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            /* gray-200 */
        }

        th {
            background-color: #f9fafb;
            /* gray-50 */
            font-weight: 600;
            color: #374151;
            /* gray-700 */
            text-transform: uppercase;
            font-size: 0.875rem;
            /* text-sm */
            position: sticky;
            /* Make headers sticky for long tables */
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background-color: #f3f4f6;
            /* gray-100 */
        }

        /* Specific styling for profit/loss column */
        .profit-positive {
            color: #10b981;
            /* green-500 */
            font-weight: 600;
        }

        .profit-negative {
            color: #ef4444;
            /* red-500 */
            font-weight: 600;
        }

        .profit-zero {
            color: #6b7280;
            /* gray-500 */
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl text-center border border-gray-200">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 tracking-tight">Detalle de Transacciones (CSV)</h1>

        <p class="text-lg text-gray-700 mb-6">Por favor, selecciona tu archivo CSV de transacciones para visualizarlo:
        </p>

        <div class="mb-6 flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <label for="csvFileInput"
                class="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">
                Seleccionar Archivo CSV
            </label>
            <input type="file" id="csvFileInput" accept=".csv" class="hidden">
            <span id="fileNameDisplay" class="text-gray-600 text-sm italic">Ningún archivo seleccionado</span>
        </div>

        <div id="csvTableContainer" class="overflow-x-auto rounded-lg shadow-md border border-gray-200 max-h-96">
            <p id="initialMessage" class="text-gray-600 p-4">Carga un archivo CSV para ver los datos aquí.</p>
            <!-- The CSV table will be inserted here by JavaScript -->
        </div>

        <div class="mt-8">
            <a href="../index.html"
                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-300">
                &larr; Volver al Resumen
            </a>
        </div>
    </div>

    <script>
        // ---------- State ----------
        let currentData = [];   // rows currently in the table
        let sortState = {};   // { column: 1=asc, -1=desc }

        // ---------- DOM refs ----------
        const csvFileInput = document.getElementById('csvFileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const csvTableContainer = document.getElementById('csvTableContainer');

        // ---------- File handling ----------
        csvFileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) {
                fileNameDisplay.textContent = 'Ningún archivo seleccionado';
                csvTableContainer.innerHTML =
                    '<p id="initialMessage" class="text-gray-600 p-4">Carga un archivo CSV para ver los datos aquí.</p>';
                return;
            }
            fileNameDisplay.textContent = file.name;
            readCSVFile(file);
        });

        function readCSVFile(file) {
            const reader = new FileReader();
            reader.onload = evt => {
                currentData = parseCSV(evt.target.result);
                renderTable(currentData);
            };
            reader.onerror = () => {
                csvTableContainer.innerHTML =
                    '<p class="text-red-500 p-4">Error al leer el archivo. Asegúrate de que es un archivo CSV válido.</p>';
            };
            reader.readAsText(file);
        }

        // ---------- CSV parsing ----------
        function parseCSV(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split(',');
                if (cells.length === headers.length && cells[0].trim() !== 'RESUMEN_TOTAL') {
                    const row = {};
                    headers.forEach((h, idx) => (row[h] = cells[idx].trim()));
                    rows.push(row);
                }
            }
            return rows;
        }

        // ---------- Table rendering ----------
        function renderTable(data) {
            csvTableContainer.innerHTML = '';
            if (!data.length) {
                csvTableContainer.innerHTML =
                    '<p class="text-gray-600 p-4">El archivo CSV está vacío o no contiene datos válidos.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';

            // --- header ---
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key.replace(/_/g, ' ').toUpperCase();
                th.style.cursor = 'pointer';
                th.className = 'select-none';
                th.onclick = () => sortBy(key);
                // arrow indicator
                const dir = sortState[key];
                if (dir) th.innerHTML += dir === 1 ? ' ▲' : ' ▼';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // --- body ---
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            data.forEach(rowData => {
                const tr = document.createElement('tr');
                Object.keys(rowData).forEach(key => {
                    const td = document.createElement('td');
                    let cell = rowData[key];

                    // Special formatting
                    if (key === 'ganancia_usdt' && cell !== '') {
                        const n = parseFloat(cell);
                        if (!isNaN(n)) {
                            cell = n.toFixed(4);
                            td.classList.add(n > 0 ? 'profit-positive' : n < 0 ? 'profit-negative' : 'profit-zero');
                        }
                    } else if (key === 'timestamp' && cell) {
                        try { cell = new Date(cell).toLocaleString(); } catch { /* keep original */ }
                    } else if (['precio', 'valor_usdt', 'cantidad'].includes(key)) {
                        const n = parseFloat(cell);
                        if (!isNaN(n)) cell = n.toFixed(4);
                    }

                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            csvTableContainer.appendChild(table);
        }

        // ---------- Sorting ----------
        function sortBy(column) {
            const direction = sortState[column] === 1 ? -1 : 1;
            sortState = { [column]: direction }; // single-column sort

            currentData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // numeric
                if (!isNaN(valA) && !isNaN(valB))
                    return direction * (parseFloat(valA) - parseFloat(valB));

                // date
                if (column === 'timestamp') {
                    const dA = new Date(valA);
                    const dB = new Date(valB);
                    if (!isNaN(dA) && !isNaN(dB))
                        return direction * (dA - dB);
                }

                // string
                return direction * valA.toString().localeCompare(valB.toString());
            });

            renderTable(currentData);
        }
    </script>
</body>

</html>