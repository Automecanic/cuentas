<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gráfica de Transacciones del Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-scroll-container {
            overflow-x: auto;
            margin-bottom: 2rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .chart-inner-wrapper {
            min-width: 1000px;
            width: max-content;
            height: 400px;
            position: relative;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        h1,
        h2 {
            text-align: center;
            font-weight: 700;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="container">
        <h1 class="text-3xl mb-6 text-gray-800">Análisis de Transacciones del Bot</h1>

        <!-- Gráfico Acumulado -->
        <div class="chart-scroll-container">
            <div class="chart-inner-wrapper">
                <h2 class="text-xl text-gray-700 mb-2">Beneficio/Pérdida Acumulado (USDT)</h2>
                <canvas id="cumulativeChart"></canvas>
            </div>
        </div>

        <!-- Gráfico por Operación -->
        <div class="chart-scroll-container">
            <div class="chart-inner-wrapper">
                <h2 class="text-xl text-gray-700 mb-2">Beneficio/Pérdida por Operación (USDT)</h2>
                <canvas id="individualChart"></canvas>
            </div>
        </div>

        <!-- Botón de regreso -->
        <div class="text-center mt-8">
            <a href="../index.html"
                class="inline-flex items-center px-6 py-3 text-base font-medium text-white bg-gray-600 hover:bg-gray-700 rounded-md shadow-sm transition">
                ← Volver al Resumen
            </a>
        </div>
    </div>

    <script type="module">
        import { csvData } from '../data.js';

        function parseCSV(csvString) {
            const lines = csvString.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const row = {};
                const values = lines[i].split(',');
                if (values.length === headers.length) {
                    headers.forEach((h, j) => {
                        row[h.trim()] = values[j].trim();
                    });
                    data.push(row);
                }
            }
            return data;
        }

        const parsedData = parseCSV(csvData).filter(d =>
            d.tipo === 'VENTA' &&
            d.ganancia_usdt &&
            d.ganancia_usdt !== 'Beneficio Total Acumulado'
        ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        let cumulative = 0;
        const acumulado = parsedData.map(d => {
            const profit = parseFloat(d.ganancia_usdt);
            cumulative += profit;
            return {
                fecha: new Date(d.timestamp),
                profit: profit,
                acumulado: cumulative,
                simbolo: d.symbol,
                motivo: d.motivo_venta
            };
        });

        // Chart 1
        new Chart(document.getElementById('cumulativeChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: acumulado.map(d => d.fecha),
                datasets: [{
                    label: 'Acumulado (USDT)',
                    data: acumulado.map(d => d.acumulado),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'yyyy-MM-dd',
                            displayFormats: { day: 'yyyy-MM-dd' }
                        },
                        title: { display: true, text: 'Fecha' },
                        ticks: { maxRotation: 45, minRotation: 45 }
                    },
                    y: {
                        title: { display: true, text: 'USDT' },
                        beginAtZero: false
                    }
                }
            }
        });

        // Chart 2
        new Chart(document.getElementById('individualChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: acumulado.map(d => `${d.simbolo} (${d.fecha.toLocaleDateString()})`),
                datasets: [{
                    label: 'Ganancia por Operación (USDT)',
                    data: acumulado.map(d => d.profit),
                    backgroundColor: acumulado.map(d =>
                        d.profit > 0 ? 'rgba(75, 192, 192, 0.8)' :
                            d.profit < 0 ? 'rgba(255, 99, 132, 0.8)' :
                                'rgba(200, 200, 200, 0.8)'
                    )
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'category',
                        title: { display: true, text: 'Operación' },
                        ticks: { maxRotation: 45, minRotation: 45 }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'USDT' }
                    }
                }
            }
        });
    </script>
</body>

</html>